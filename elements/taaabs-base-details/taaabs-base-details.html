<link rel="import" href="../../bower_components/taaabs-themes/taaabs-dark-theme.html">
<dom-module id="taaabs-base-details">


  <template>
    <style include="taaabs-dark-theme"></style>
    <style>
      :host {
        display: block;
        width: 100%;
        height: 100%;
      }

      table {
        width: 100%;
      }

      th {
        text-align: left;
      }

      dt {
        font-weight: bold;
      }

      #modes {
        display: block;
        width: 100%;
      }

      #visuMode {
        display: block;
        float: left;
        width: 100%;
        opacity: 1;
        -webkit-transition: opacity .3s ease-in-out;
        -moz-transition: opacity .3s ease-in-out;
        -ms-transition: opacity .3s ease-in-out;
        -o-transition: opacity .3s ease-in-out;
        transition: opacity .3s ease-in-out;
      }

      #editMode {
        display: block;
        float: left;
        width: 100%;
        margin-left: -100%;
        opacity: 0;
        pointer-events: none;
        -webkit-transition: opacity .3s ease-in-out;
        -moz-transition: opacity .3s ease-in-out;
        -ms-transition: opacity .3s ease-in-out;
        -o-transition: opacity .3s ease-in-out;
        transition: opacity .3s ease-in-out;
      }

      .editIcons {
        float: right;
        opacity: 0.87;
        cursor: pointer;
      }

      .editIcons:hover {
        opacity: 1;
      }

      .baseLine:hover {
        cursor: pointer;
        background-color: #2e3842;
        color: white;
      }

      :host #bgModal {
        position: absolute;
        top: 0px;
        left: 0px;
        width: 100vw;
        height: 100vh;
        background-color: rgba(0, 0, 0, 0.37);
        opacity: 0;
        pointer-events: none;
        -webkit-transition: opacity .3s ease-in-out;
        -moz-transition: opacity .3s ease-in-out;
        -ms-transition: opacity .3s ease-in-out;
        -o-transition: opacity .3s ease-in-out;
        transition: opacity .3s ease-in-out;
      }

      :host #contentModal {
        position: absolute;
        top: 50vh;
        margin-top: -200px;
        left: 50vw;
        margin-left: -300px;
        width: 600px;
        height: 400px;
        padding: 1em;
      }
    </style>

    <!-- Modal for Base Creation -->

    <div id="bgModal">
      <div id="contentModal" class="bgWhite">
        <iron-pages selected="{{_modalIndex}}">
          <div>
            <taaabs-base-create id="tbc" source="[[_base]]" language="{{language}}" in-base></taaabs-base-create>
          </div>
        </iron-pages>
      </div>
    </div>

    <!-- Title -->

    <h3> <span>{{localize('baseInformations')}} : <span>{{_base.id}}</span> </h3>

    <!-- Base Main Information Divs -->

    <div id="modes">
      <div id="visuMode">
        <iron-icon icon="icons:create" title="{{localize('editIcon')}}" class="editIcons" id="editIcon"></iron-icon>
        <dl>
          <dt> Url </dt>
          <dd> <a href="{{_base.uri}}" target="_blank"><span>{{_base.uri}}</span></a></dd>
          <dt> Label </dt>
          <dd> <span>{{_base.label}}</span></dd>
          <dt> Description </dt>
          <dd> <span>{{_base.comment}}</span></dd>
        </dl>
      </div>

      <div id="editMode">
        <iron-icon icon="icons:close" class="editIcons fgRed fgRedH" title="{{localize('editCancelIcon')}}" id="editCancelIcon"></iron-icon>
        <iron-icon icon="icons:check" class="editIcons fgGreen fgGreenH" title="{{localize('editSubmitIcon')}}" id="editSubmitIcon"></iron-icon>
        <dl>
          <dt> Url </dt>
          <dd> <a href="{{_base.uri}}" target="_blank"><span>{{_base.uri}}</span></a></dd>
          <dt> Label </dt>
          <dd>
            <input type="text" value="{{_baseLabel::input}}">
          </dd>
          <dt> Description </dt>
          <dd>
            <textarea value="{{_baseComment::input}}"></textarea>
          </dd>
        </dl>
      </div>
    </div>

    <!-- Child Base List -->

    <iron-icon style="float:right; cursor: pointer;padding-bottom:5px" class="fgDarkBlue fgDarkBlueH" icon="icons:add-circle-outline" on-click="_createBase"></iron-icon>
    <h4 style="margin-bottom: 0px">Bases</h4>
    <table>
      <tr>
        <th> Id </th>
        <th> Label </th>
        <th> Description </th>
        <th></th>
      </tr>
      <template is="dom-repeat" items="{{_bases}}">
        <tr on-click="_resourceClicked" class="baseLine">
          <td> <span>{{item.id}}</span> </td>
          <td> <span>{{item.label}}</span> </td>
          <td> <span>{{item.comment}}</span> </td>
          <td style="width:15px">
            <iron-icon on-click='_deleteResource' icon="icons:delete" title="{{localize('delete')}}" class="fgWhite" style="height: 15px;"></iron-icon>
          </td>
        </tr>
      </template>
    </table>

    <!-- Stored Traces List -->

    <h4> <span>{{localize('storedTraces')}}</span> </h4>
    <table>
      <tr>
        <th> Id </th>
        <th> Label </th>
        <th> Description </th>
      </tr>
      <template is="dom-repeat" items="{{_storedTraces}}">
        <tr on-click="_resourceClicked" class="baseLine">
          <td> <span>{{item.id}}</span> </td>
          <td> <span>{{item.label}}</span> </td>
          <td> <span>{{item.comment}}</span> </td>
        </tr>
      </template>
    </table>

    <!-- Computed Traces List -->

    <h4> <span>{{localize('computedTraces')}}</span> </h4>
    <table>
      <tr>
        <th> Id </th>
        <th> Label </th>
        <th> Description </th>
      </tr>
      <template is="dom-repeat" items="{{_computedTraces}}">
        <tr on-click="_resourceClicked" class="baseLine">
          <td> <span>{{item.id}}</span> </td>
          <td> <span>{{item.label}}</span> </td>
          <td> <span>{{item.comment}}</span> </td>
        </tr>
      </template>
    </table>

    <!-- Trace Model List -->

    <h4> <span>{{localize('traceModels')}}</span> </h4>
    <table>
      <tr>
        <th> Id </th>
        <th> Label </th>
        <th> Description </th>
      </tr>
      <template is="dom-repeat" items="{{_traceModels}}">
        <tr on-click="_resourceClicked" class="baseLine">
          <td> <span>{{item.id}}</span> </td>
          <td> <span>{{item.label}}</span> </td>
          <td> <span>{{item.comment}}</span> </td>
        </tr>
      </template>
    </table>
  </template>

  <script>
    Polymer({
      is: 'taaabs-base-details',

      /**
       * Fired if a resource has been clicked.
       *
       * Returns an object :
       *
       *    {
       *      "resourceURL":<url_of_the_resource>,
       *      "resourceType":"StoredTrace" || "ComputedTrace" || "TraceModel",
       *      "which": <mouse_button>
       *    }
       *
       * If mouse_button = 2, then it's a middle-click
       * @event RESOURCE_SELECTED
       */

      properties: {

        /**
         * The base URL.
         *
         * @attribute baseUrl
         * @type String
         */
        baseUrl: {
          type: String,
          notify: true,
          value: ""
        },

        /**
         * The base label.
         *
         * @attribute _baseLabel
         * @type String
         */
        _baseLabel: {
          type: String,
          notify: true,
          value: ""
        },

        /**
         * The base notes.
         *
         * @attribute _baseNote
         * @type String
         */
        _baseComment: {
          type: String,
          notify: true,
          value: ""
        },

        /**
         * The base object.
         *
         * @attribute _base
         * @type Object
         */
        _base: {
          type: Object,
          notify: true,
          value: null,
          observer: '_baseChanged'
        },

        /**
         * The stored traces of the base.
         *
         * @attribute _storedTraces
         * @type Array
         */
        _storedTraces: {
          type: Array,
          notify: true,
          value: function() {
            return [];
          }
        },

        /**
         * The bases of the base.
         *
         * @attribute _bases
         * @type Array
         */
        _bases: {
          type: Array,
          notify: true,
          value: function() {
            return [];
          }
        },

        /**
         * The computed traces of the base.
         *
         * @attribute _computedTraces
         * @type Array
         */
        _computedTraces: {
          type: Array,
          notify: true,
          value: function() {
            return [];
          }
        },

        /**
         * The models of the base.
         *
         * @attribute _traceModels
         * @type Array
         */
        _traceModels: {
          type: Array,
          notify: true,
          value: function() {
            return [];
          }
        },

        /**
         * Index of the page of the modal div.
         * 0 for base creation page, etc.
         *
         * @attribute _modalIndex
         * @type Number
         */
        _modalIndex: {
          type: Number,
          notify: true,
          value: 0
        },

        /**
         * Set to true if the taaabs-base-overview must work with a `taaabs-resource-loader`. False otherwise.
         *
         * @attribute taaabsCentralLoading
         * @type Boolean
         */
        taaabsCentralLoading: {
          type: Boolean,
          notify: true,
          value: false
        },

        /**
         * Localization.
         * fr, en.
         *
         * @attribute language
         * @type String
         */
        language: {
          type: String,
          notify: true,
        },

      },

      listeners: {
        'loadResource': '_loadResource',
        'editIcon.click': '_switchToEditMode',
        'editCancelIcon.click': '_switchToNotEditMode',
        'editSubmitIcon.click': '_submitBaseChanges'
      },

      behaviors: [
        Polymer.AppLocalizeBehavior
      ],

      ready: function() {},

      attached: function() {
        // Load i18n json.
        this.loadResources(this.resolveUrl('./locales.json'));
        // Listen for base creation
        this.$.tbc.addEventListener('BASE_CREATED', function() {
          this.fire('RESOURCE_CHANGED');
          this.$.bgModal.style.opacity = 0;
          this.$.bgModal.style.pointerEvents = "none";
          window.scrollTo(0, 0);
        }.bind(this));
        // Close the modal if base creation is canceled
        this.$.tbc.addEventListener('CANCEL', function() {
          this.$.bgModal.style.opacity = 0;
          this.$.bgModal.style.pointerEvents = "none";
          window.scrollTo(0, 0);
        }.bind(this));
      },

      /**
       * Reset the base and resources arrays. Load every resource of the base.
       *
       * @method refresh
       */
      refresh: function() {
        // RESET ALL THE THINGS !!
        this.set('_base', null);
        this.set('_bases', []);
        this.set('_storedTraces', []);
        this.set('_computedTraces', []);
        this.set('_traceModels', []);
        // If we use a resoure-loader, well, we let it load the resources then.
        if (this.taaabsCentralLoading)
          this.fire('GET_RESOURCE', {
            url: this.baseUrl,
            obj: "_base"
          });
        // Otherwise, set _base with a new Samotrace.Base.
        else
          this.set('_base', new Samotraces.Ktbs.Base(this.baseUrl));

      },

      /**
       * Triggered when a resource is clicked. Fires `RESOURCE_SELECTED` with the resource object.
       *
       * @param {!required} e (Event) The click event.
       *
       * @method _resourceClicked
       */
      _resourceClicked: function(e) {
        var res = e.model.item;
        res.uri = this._base.getAbsoluteURLFromRelative(this._base.uri, res.id);
        this.fire('RESOURCE_SELECTED', {
          "resource": res,
          "which": e.which
        });
      },

      /**
       * Change some css to display the edit panel
       *
       * @method _switchToEditMode
       */
      _switchToEditMode: function() {
        this.$.visuMode.style.opacity = 0;
        this.$.visuMode.style.pointerEvents = 'none';
        this.$.editMode.style.opacity = 1;
        this.$.editMode.style.pointerEvents = 'auto';
      },

      /**
       * Change some css to hide the edit panel
       *
       * @method _switchToNotEditMode
       */
      _switchToNotEditMode: function() {
        this.$.visuMode.style.opacity = 1;
        this.$.visuMode.style.pointerEvents = 'auto';
        this.$.editMode.style.opacity = 0;
        this.$.editMode.style.pointerEvents = 'none';
      },

      /**
       * PUT the new base params (label and notes).
       *
       * @method _submitBaseChanges
       */
      _submitBaseChanges: function() {
        // Init the new attributes to PUT in the base.
        var obj = [
          ["label", this._baseLabel],
          ["http://www.w3.org/2000/01/rdf-schema#comment", [this._baseComment]]
        ];
        // Set the new attributes of the base
        this._base.modify_attributes(obj).then(function(response) {
            this.set('_base.label', that._base.label);
            this.set('_baseLabel', that._base.label);
            this.set('_base.comment', that._base.comment);
            this.set('_baseComment', that._base.comment);
            this._switchToNotEditMode();
          }.bind(this))
          .catch(function(err) {
            console.log(err);
          });
      },

      /**
       * Triggered when `_base` changes. Load its child resources.
       *
       * @method _baseChanged
       */
      _baseChanged: function() {
        if (this._base) {
          this._base.load_properties(['label', 'comment'])
            .then(function(resources) {
              this._setResources(resources);
            }.bind(this))
            .catch(function(err) {
              console.log(err);
            });
        }
      },

      /**
       * Format the raw resources of the base for display purpose. Push the resources into its respective list.
       *
       * @param {!required} resources (Array) The child resources of `_base`.
       *
       * @method _setResources
       */
      _setResources: function(resources) {
        for (var i in resources) {
          resources[i].id = resources[i]['@id'];
          //TODO Replace Array position by real String.
          if (resources[i]['rdf:comments'])
            resources[i].comment = resources[i]['rdf:comments'][0];
          switch (resources[i]['@type']) {
            case 'Base':
              this.push('_bases', resources[i]);
              break;
            case 'StoredTrace':
              this.push('_storedTraces', resources[i]);
              break;
            case 'ComputedTrace':
              this.push('_computedTraces', resources[i]);
              break;
            case 'TraceModel':
              this.push('_traceModels', resources[i]);
              break;
          }
        }
      },

      /**
       * Triggered when a "delete resource" button is clicked.
       *
       * @param {!required} e (Event) The click event.
       *
       * @method _deleteResource
       */
      _deleteResource: function(e) {
        if (window.confirm(this.localize('deleteConfirm') + " " + e.model.item['@id'] + " ?")) {
          var res = new Samotraces.Ktbs.Resource(this._base.uri + e.model.item['@id']);
          res.remove()
            .then(function(msg) {
              this.fire('RESOURCE_CHANGED');
            }.bind(this))
            .catch(function(err) {
              console.log(err);
            });
        }
      },

      /**
       * Triggered when the "create base" button is clicked.
       * Show the modal.
       *
       * @method _createBase
       */
      _createBase: function() {
        this.$.bgModal.style.opacity = 1;
        this.$.bgModal.style.pointerEvents = "auto";
        window.scrollTo(0, 0);
      },

    });
  </script>
</dom-module>
