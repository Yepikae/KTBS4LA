<link rel="import" href="../../bower_components/google-chart/google-chart.html">
<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">

<link rel="import" href="sparql-table-handler.html">
<link rel="import" href="sparql-obsel-timeline-handler.html">
<link rel="import" href="../../bower_components/taaabs-themes/taaabs-dark-theme.html">

<dom-module id="yasgui-component">
  <template>
    <style include="taaabs-dark-theme"></style>
    <style>
      .flex-horizontal {
        @apply(--layout-horizontal);
      }

      .flexchild {
        @apply(--layout-flex);
      }

      :host .activePanel {
        background-color: #35ccbf;
      }

      :host .button {
        width: 100%;
        text-align: center;
      }
    </style>


    <div class="container flex-horizontal">
      <div class="flexchild">
        <div class="button activePanel" on-click="_onRawDatasClicked">Raw datas</div>
      </div>
      <div class="flexchild" on-click="_onTimelineClicked">
        <div class="button">Timeline</div>
      </div>
      <div class="flexchild" on-click="_onGoogleChartClicked">
        <div class="button">Google chart</div>
      </div>
    </div>


    <iron-pages selected="{{_visuIndex}}">
      <div>
        <sparql-table-handler id="sparqlTableHandler"></sparql-table-handler>
      </div>
      <div>
        <sparql-obsel-timeline-handler id="sparqlObselTimelineHandler"></sparql-obsel-timeline-handler>
      </div>
      <div>

      </div>
    </iron-pages>
    <!--  <div id="showcase"></div> -->
  </template>

  <script>
    Polymer({
      is: "yasgui-component",

      properties: {

        endPoint: {
          type: String,
          notify: true,
          value: "",
          observer: "_endPointChanged"
        },

        _yasqe: {
          type: Object,
          notify: true,
          value: null
        },

        _yasr: {
          type: Object,
          notify: true,
          value: null
        },

        _query: {
          type: String,
          notify: true,
          value: ""
        },

        _spareQuery: {
          type: String,
          notify: true,
          value: ""
        },

        /**
         * Index of the displayed visualization.
         *
         * @attribute _visuIndex
         * @type Number
         */
        _visuIndex: {
          type: Number,
          notify: true,
          value: 0
        },

        /**
         * The last response received from a sparql query.
         *
         * @attribute _lastResponse
         * @type String
         */
        _lastResponse: {
          type: String,
          notify: true,
          value: null
        },

      },

      ready: function() {
        this.set('_yasqe', new YASGUI.YASQE());
      },

      attached: function() {},

      refresh: function(query, spareQuery) {

        console.log(query);

        query = query || this._query;
        this.set('_query', query);
        this.set('_spareQuery', spareQuery);
        //this._yasqe.setValue( query );
        //this._yasqe.query( this._drawResponse.bind(this) )

        var that = this;

        var xhr = new XMLHttpRequest();
        xhr.open('POST', this.endPoint, true);
        xhr.setRequestHeader('Accept', 'application/json');
        xhr.setRequestHeader('Content-Type', 'application/sparql-query');
        xhr.withCredentials = true;
        xhr.onerror = function(err) {
          console.log(err + xhr.status);
        };
        xhr.onreadystatechange = function() {
          if (xhr.readyState === 4) {
            that._drawResponse(xhr.response);
          }
        };

        xhr.send(query);

      },

      _drawResponse: function(response) {
        console.log(this.$.sparqlTableHandler);

        this.set('_lastResponse', response);

        this.set('_visuIndex', 0);
        this.$.sparqlTableHandler.format(this._lastResponse);
      },

      _endPointChanged: function() {

        if (this.endPoint !== "")
          this._yasqe.options.sparql.endpoint = this.endPoint;

      },

      /**
       * Display the response as it.
       *
       * @method _onRawDatasClicked
       */
      _onRawDatasClicked: function() {
        this.set('_visuIndex', 0);
        this.$.sparqlTableHandler.format(this._lastResponse);
      },

      /**
       * Display the response in a trace timeline.
       *
       * @method _onTimelineClicked
       */
      _onTimelineClicked: function() {
        this.set('_visuIndex', 1);
        this.$.sparqlObselTimelineHandler.format(this._lastResponse, this._query, this._spareQuery);
      },

      /**
       * Display the response with google charts.
       *
       * @method _onGoogleChartClicked
       */
      _onGoogleChartClicked: function() {

      }

    });
  </script>
</dom-module>
<script type="text/javascript" src="yasgui.min.js"></script>
