<!-- <script src="pixi.min.js"></script> -->
<script src="script.js"></script>

<link rel="import" href="taaabs-trace-timeline-visu.html">
<link rel="import" href="taaabs-trace-timeline-timeline.html">

<link rel="import" href="taaabs-trace-timeline-icons.html">
<link rel="import" href="../../bower_components/taaabs-themes/taaabs-dark-theme.html">

<link rel="import" href="../taaabs-trace-timeline-stylesheet/taaabs-trace-timeline-stylesheet.html">
<link rel="import" href="../taaabs-trace-timeline-stylesheet/taaabs-tts-editor.html">
<link rel="import" href="../taaabs-trace-timeline-stylesheet/taaabs-tts-rule.html">


<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">


<link rel="import" href="../../bower_components/taaabs-themes/taaabs-dark-theme.html">


<!-- TEMPORARY -->
<link rel="import" href="../taaabs-trace-loader/taaabs-trace-loader.html">

<dom-module id="taaabs-trace-timeline">

  <template>
    <style include="taaabs-dark-theme"></style>
    <style>
      :host {
        display: block;
        width: 100%;
      }

      :host #tttv {
        border-top: solid 1px grey;
      }
      /*////////////*/
      /* STYLESHEET */
      /*////////////*/

      :host .activePanel {
        background-color: #35ccbf;
      }

      :host .ttsRule:nth-child(odd) {
        background-color: rgba(144, 144, 144, 0.25);
      }
      /*//////////////*/
      /* PROGRESS BAR */
      /*//////////////*/

      :host #progress {
        width: 100%;
        height: 5px;
      }

      :host #progressInner {
        width: 0px;
        height: 5px;
        animation: pulse 1s infinite alternate;
        -webkit-transition: width .35s ease-in-out, opacity 1s ease-in-out;
        -moz-transition: width .35s ease-in-out, opacity 1s ease-in-out;
        -ms-transition: width .35s ease-in-out, opacity 1s ease-in-out;
        -o-transition: width .35s ease-in-out, opacity 1s ease-in-out;
        transition: width .35s ease-in-out, opacity 1s ease-in-out;
      }

      @keyframes pulse {
        0% {
          background-color: #21b2a6;
        }
        100% {
          background-color: #6CD6CE;
        }
      }
      /*/////////////////////*/
      /* STYLESHEETS MANAGER */
      /*/////////////////////*/

      #smContainer {
        margin: 0 auto;
        width: 1000px;
      }
      /* smContainer Icons */

      #smContainer> div {
        float: right;
      }

      #smContainer> div iron-icon {
        cursor: pointer;
      }

      .smTile {
        display: table;
        table-layout: fixed;
        width: 100%;
      }

      .smTileMain {
        display: table-cell;
        width: 100%;
        padding: 10px;
        background-color: white;
        cursor: pointer;
        -webkit-transition: background-color .25s ease-in-out;
        -moz-transition: background-color .25s ease-in-out;
        -ms-transition: background-color .25s ease-in-out;
        -o-transition: background-color .25s ease-in-out;
        transition: background-color .25s ease-in-out;
      }

      .smTileMain:hover {
        background-color: rgba(144, 144, 144, 0.25);
      }

      .smTileIcons {
        display: table-cell;
        width: 40px;
      }

      .smTileIcons iron-icon {
        cursor: pointer;
      }

      :host .container {
        width: 100%;
        height: 100%;
        overflow: hidden;
      }

      :host .flex-horizontal {
        @apply(--layout-horizontal);
      }

      :host .flexchild {
        @apply(--layout-flex);
      }

      :host #menu {
        height: 100%;
        width: 70px;
        border-right: solid 2px grey;
        @apply(--layout-vertical);
        /*@apply(--layout-justified);*/
      }

      :host .btn {
        width: 50px;
        height: 50px;
        text-align: center;
        margin-left: 10px;
        margin-top: 10px;
        font-size: 25px;
        padding-top: 10px;
        text-transform: uppercase;
        cursor: pointer;
      }
    </style>

    <div class="container flex-horizontal">
      <div id="menu">
        <div class="btn bgLightBlue bgLightBlueH fgWhite">G</div>
        <div class="btn bgLightBlue bgLightBlueH fgWhite">T</div>
        <div class="btn bgLightBlue bgLightBlueH fgWhite">Sl</div>
        <div class="btn bgLightBlue bgLightBlueH fgWhite">Ov</div>
        <div class="btn bgLightBlue bgLightBlueH fgWhite">Mv</div>
        <div class="btn bgLightBlue bgLightBlueH fgWhite">Se</div>
        <div class="btn bgLightBlue bgLightBlueH fgWhite">Sv</div>
        <div class="btn bgLightBlue bgLightBlueH fgWhite">St</div>
      </div>
      <div class="flexchild">
        <golden-layout-component id="glc"></golden-layout-component>
      </div>
    </div>


    <div id="general_infos">
      <div style="display: table; margin: 0 auto; width: 300px; font-size: 11px">
        <div style="display: table-cell;text-align: right; padding-right: 10px;  text-transform: uppercase; width: 50%"> Trace url </div>
        <div style="display: table-cell;text-align: left;  50%"> {{traceUrl}} </div>
      </div>
      <div style="display: table; margin: 0 auto; width: 300px; font-size: 11px">
        <div style="display: table-cell;text-align: right; padding-right: 10px;  text-transform: uppercase; width: 50%"> Begin of the trace </div>
        <div style="display: table-cell;text-align: left;  50%"> {{_getDateFormatted(_traceBegin)}} </div>
      </div>
      <div style="display: table; margin: 0 auto; width: 300px;  font-size: 11px">
        <div style="display: table-cell; text-align: right; padding-right: 10px; text-transform: uppercase;  width: 50%"> End of the trace </div>
        <div style="display: table-cell;text-align: left;  50%"> {{_getDateFormatted(_traceEnd)}} </div>
      </div>
      <div style="display: table; margin: 0 auto; width: 300px;  font-size: 11px">
        <div style="display: table-cell;text-align: right; padding-right: 10px; text-transform: uppercase; width: 50%"> Obsels Count </div>
        <div style="display: table-cell;text-align: left;  50%"> {{_obselCount}} </div>
      </div>
    </div>

    <div id="timelines">
      <div id="progress">
        <div id="progressInner">
        </div>
      </div>
      <taaabs-trace-timeline-visu id="tttv" obsels="{{_obsels}}" format="DATE" style-template="[[traceStyleSheet]]" grad="{{_grad}}" width="100%">
      </taaabs-trace-timeline-visu>

      <taaabs-trace-timeline-timeline id="tttt" format="DATE" grad="{{_grad}}" style="width: 100%">
      </taaabs-trace-timeline-timeline>
      <!-- <pixi-js-component id="pixijs" flex-width></pixi-js-component> -->
    </div>

    <!-- /////////////////// -->
    <!-- STYLESHEETS MANAGER -->
    <!-- /////////////////// -->

    <div id="smContainer">
      <div>
        <iron-icon icon="icons:launch" class="fgDarkBlue fgDarkBlueH" on-click="_onLaunchFilterClick"></iron-icon>
        <iron-icon icon="icons:save" class="fgDarkBlue fgDarkBlueH" on-click="_saveCurrentStylesheet"></iron-icon>
        <iron-icon icon="icons:settings" class="fgDarkBlue fgDarkBlueH" on-click="_onStylesheetsManagerSettingsClick"></iron-icon>
      </div>
      <h5> [[_stylesheet.obj.name]] </h5>
      <p> [[_stylesheet.obj.description]] </p>
      <div hidden$="{{_hideStylesheetsManager}}">
        <div>
          StyleSheets
          <iron-icon icon="icons:add-circle-outline" on-click="_createStylesheet"></iron-icon>
        </div>
        <div>
          <template is="dom-repeat" items="{{_stylesheets}}" index-as="index">

            <div class="smTile" style$="border: solid 1px {{_getStylesheetStatusColor(item)}};">

              <div class="smTileMain" on-click='_useStylesheet'>

                <input placeholder="name" class="inputWithIcon" style="outline:0" value="{{item.obj.name::input}}">
                <iron-icon class="inputWithIconIcon fgDarkBlue" icon="icons:create"></iron-icon>
                </input>

                <input placeholder="description" class="inputWithIcon" style="outline:0" value="{{item.obj.description::input}}">
                <iron-icon class="inputWithIconIcon fgDarkBlue" icon="icons:create"></iron-icon>
                </input>

              </div>

              <div class="smTileIcons" style="">

                <div>
                  <iron-icon class="icon fgRed fgRedH" icon="icons:clear" title="[[localize('delete')]]" on-click="_deleteCurrentStylesheet"></iron-icon>
                </div>
                <div>
                  <iron-icon class="icon fgDarkBlue fgDarkBlueH" icon="icons:save" title="[[localize('save')]]"></iron-icon>
                </div>
                <div>
                  <iron-icon class="icon fgDarkBlue fgDarkBlueH" icon="icons:content-copy">
                  </iron-icon>
                </div>

              </div>

            </div>

          </template>
        </div>
      </div>
    </div>


    <div id="obsel_view" style=" padding: 5px; display: block; width : 100%">
      <div style="padding:5px;color:white; width: 100%; text-align: center">
        <h4>{{_obselSelected.id}}</h4>
      </div>
      <div style="padding:10px;width: 100%; broder-bottom: solid 1px gray">
        <div><b>Type: </b>{{_obselSelected.type}}</div>
        <div><b>Begin: </b>{{_obselSelected.begin}}</div>
        <div><b>End: </b>{{_obselSelected.end}}</div>
      </div>
      <div style="padding:10px;width: 100%;">
        <table>
          <thead>
            <tr>
              <th> Attribute </th>
              <th> Value </th>
              <th> Create template </th>
            </tr>
          </thead>
          <tbody>
            <template is="dom-repeat" items="{{_obselSelected.attributes}}">
              <tr>
                <td>{{item.name}}</td>
                <td>{{item.value}}</td>
                <td>
                  <iron-icon icon="icons:launch" on-click="_addAttributeToStyle"></iron-icon>
                </td>
              </tr>
            </template>
          </tbody>
        </table>
      </div>
    </div>

    <!-- ////////// -->
    <!-- MODEL VIEW -->
    <!-- ////////// -->

    <div id="model_view" style=" padding: 5px; display: block; width : 100%">
      <table>
        <thead>
          <tr>
            <td>Model types</td>
            <td></td>
          </tr>
        </thead>
        <tbody>
          <template is="dom-repeat" items="{{_listTypeObsels}}">
            <tr>
              <td>{{item}}</td>
              <td>
                <iron-icon icon="icons:launch" on-click="_addModelTypeToRule"></iron-icon>
              </td>
            </tr>
          </template>
        </tbody>
        <thead>
          <tr>
            <td>Model attributes</td>
            <td></td>
          </tr>
        </thead>
        <tbody>
          <template is="dom-repeat" items="{{_listTypeAttributes}}">
            <tr>
              <td>{{item}}</td>
              <td>
                <iron-icon icon="icons:launch" on-click="_addModelAttributeToRule"></iron-icon>
              </td>
            </tr>
          </template>
        </tbody>
      </table>
    </div>

    <taaabs-tts-editor id="t3se"></taaabs-tts-editor>


    <div id="style_view" style=" padding: 5px;">
      <template is="dom-repeat" id="stylesListRepeat" items="{{_stylesList}}">
        <div class="ttsRule" style="display: table; table-layout: fixed; width : 100%;">

          <!-- ////// -->
          <!-- SYMBOL -->
          <!-- ////// -->


          <div style="display: table-cell; width: 60px; position: relative">
            <div style=" display: block; position: absolute; margin-top: -12px; margin-left: -12px; left: 50%; top: 50%; width: 36px; height: 36px">
              <iron-icon class="icon fgDarkBlue fgDarkBlueH" icon="[[_getVisibility(item.enabled)]]" title="[[localize(_getVisibility(rule.enabled))]]" on-click="_onVisibilityClicked">
              </iron-icon>
            </div>
          </div>

          <div style="display: table-cell; width: 60px; position: relative">
            <div style=" display: block; position: absolute; margin-top: -18px; margin-left: -18px; left: 50%; top: 50%; width: 36px; height: 36px">
              <iron-icon icon="timeline-symbols:{{item.symbol.shape}}" style$="color: {{item.symbol.color}}; width: 36px; height: 36px"></iron-icon>
            </div>

          </div>

          <!-- ///// -->
          <!-- RULES -->
          <!-- ///// -->

          <div style="display: table-cell; width: 100%">

            <div>
              <b><span>{{item.typeObsel.name}}</span></b>
            </div>

            <template is="dom-repeat" items="{{item.attributes}}">
              <div>
                <span>{{item.name}}</span>
                <span>{{item.operator}}</span>
                <span>{{item.val}}</span>
              </div>
            </template>

          </div>

          <!-- /////// -->
          <!-- OPTIONS -->
          <!-- /////// -->

          <div style="display: table-cell; width: 40px">

            <div>
              <iron-icon class="icon fgRed fgRedH" icon="icons:clear" title="[[localize('delete')]]" on-click="_onDeleteClicked"></iron-icon>
            </div>
            <div>
              <iron-icon class="icon fgDarkBlue fgDarkBlueH" icon="icons:settings" title="[[localize('settings')]]" on-click="_onSettingsClicked"></iron-icon>
            </div>
            <div>
              <iron-icon class="icon fgDarkBlue fgDarkBlueH" icon="icons:content-copy" on-click="_onDuplicateClicked">
              </iron-icon>
            </div>

          </div>

        </div>
      </template>

    </div>

    <div id="style_text" style="width: 1000px; height: 400px; margin: 0 auto">
      <taaabs-trace-timeline-stylesheet rules="{{_stylesList}}" style-sheet="{{traceStyleSheet}}" id="ttts">
      </taaabs-trace-timeline-stylesheet>
    </div>

    <paper-dialog style="width: 90vw; height: 90vh;" id="filterDialog">
      <h2>Header</h2>
      <paper-dialog-scrollable>
        <taaabs-generic-method id="tgm" language="[[language]]">
        </taaabs-generic-method>
      </paper-dialog-scrollable>
      <div class="buttons">
        <paper-button dialog-dismiss>Cancel</paper-button>
        <paper-button dialog-confirm autofocus>Accept</paper-button>
      </div>
    </paper-dialog>



    <taaabs-trace-loader id="traceLoader" trace-url="[[traceUrl]]" obsels="{{_obsels}}"></taaabs-trace-loader>

  </template>

  <script>
    Polymer({
      is: 'taaabs-trace-timeline',
      properties: {

        /**
         * Url of the current trace.
         *
         * @attribute traceUrl
         * @type String
         */
        traceUrl: {
          type: String,
          notify: true,
          value: "",
          observer: "_onTraceUrlChanged"
        },

        ///////////////////////////
        // STYLESHEET PROPERTIES //
        ///////////////////////////

        traceStyleSheet: {
          type: String,
          notify: true,
        },

        ////////////////////
        // KTBS RESOURCES //
        ////////////////////

        /**
         * Obsel selected onto the timeline.
         *
         * @attribute _obselSelected
         * @type Object
         */
        _obselSelected: {
          type: Object,
          notify: true,
          value: null,
          observer: "_onObselSelectedChange"
        },

        /**
         * List of the obsels of the trace.
         *
         * @attribute _obsels
         * @type Array
         */
        _obsels: {
          type: Array,
          notify: true,
          value: []
        },

        /**
         * The current trace.
         *
         * @attribute _trace
         * @type Object
         */
        _trace: {
          type: Object,
          notify: true,
          value: null
        },

        /**
         * The current trace model.
         *
         * @attribute _model
         * @type Object
         */
        _model: {
          type: Object,
          notify: true,
          value: null
        },

        /**
         * List of the `_model` types.
         *
         * @attribute _listTypeObsels
         * @type Array
         */
        _listTypeObsels: {
          type: Array,
          notify: true,
          value: []
        },

        /**
         * List of the `_model` attributes
         *
         * @attribute _listTypeAttributes
         * @type Array
         */
        _listTypeAttributes: {
          type: Array,
          notify: true,
          value: []
        },

        /////////////////////////
        // TIMELINE PROPERTIES //
        /////////////////////////

        /**
         * Begin time of the first obsel of the trace.
         *
         * @attribute _traceBegin
         * @type Number
         */
        _traceBegin: {
          type: Number,
          notify: true,
          value: -1
        },

        /**
         * End time of the last obsel of the trace.
         *
         * @attribute _traceEnd
         * @type Number
         */
        _traceEnd: {
          type: Number,
          notify: true,
          value: -1
        },

        /**
         * Number of obsels in the trace.
         *
         * @attribute _obselCount
         * @type Number
         */
        _obselCount: {
          type: Number,
          notify: true,
          value: 0
        },

        ///////////////////
        // UI PROPERTIES //
        ///////////////////

        /**
         * Index of the view between obsel and model.
         *
         * @attribute _obselOrModelView
         * @type Number
         */
        _obselOrModelView: {
          type: Number,
          notify: true,
          value: 0
        },

        /**
         * Index of the view between object and text (for the stylesheet).
         *
         * @attribute _objectOrTextView
         * @type Number
         */
        _objectOrTextView: {
          type: Number,
          notify: true,
          value: 0
        },

        ////////////////////////
        // PROCESS PROPERTIES //
        ////////////////////////

        /**
         * True if the taaabs-trace-timeline is already loading the obsels of the trace.
         * False otherwise.
         *
         * @attribute _loading
         * @type Boolean
         */
        _loading: {
          type: Boolean,
          notify: true,
          value: false
        },

        /**
         * Last obsel retrieved. Used to retrieve the next obsels.
         *
         * @attribute _lastObsel
         * @type Object
         */
        _lastObsel: {
          type: Object,
          notify: true,
          value: null
        },

        ///////////////////////////
        // STYLESHEET PROPERTIES //
        ///////////////////////////

        /**
         * List of the timeline stylesheet rules.
         *
         * @attribute _stylesList
         * @type Array
         */
        _stylesList: {
          type: Array,
          notify: true,
          value: function() {
            return [];
          }
        },

        /**
         * List of the stylesheets registered one the `_model` or the `_trace`.
         *
         * @attribute _stylesheets
         * @type Array
         */
        _stylesheets: {
          type: Array,
          notify: true,
          value: []
        },

        /**
         * The current stylesheet.
         *
         * @attribute _stylesheet
         * @type Object
         */
        _stylesheet: {
          type: Object,
          notify: true,
          value: null
        },

        /**
         * True if the stylesheet manager ( ui ) must be hidden. False otherwise.
         *
         * @attribute _hideStylesheetsManager
         * @type Boolean
         */
        _hideStylesheetsManager: {
          type: Boolean,
          notify: true,
          value: true
        },

        //////////
        // I18N //
        //////////

        /**
         * Localization.
         * fr, en.
         *
         * @attribute language
         * @type String
         */
        language: {
          type: String,
          notify: true
        },
      },

      listeners: {
        'getObsels': '_getObsels'
      },

      ready: function() {},

      attached: function() {
        var that = this;

        // Add a new styling rule to the strylesheet.
        this.$.t3se.addEventListener('APPLY_STYLE', function(e) {
          that._addRuleToStylesheet(e.detail.style);
          that._updateDisplay();
        });
        this.$.t3se.addEventListener('UPDATE_STYLE', function(e) {
          var tmp = that._stylesList.slice();
          that.set('_stylesList', []);

          //TODO Remove this ugly thing when Polymer is ok
          setTimeout(function() {
            that.set("_stylesList", tmp);
            that._updateDisplay();
          }, 100);

        });

        /*
        this.$.glc.registerComponent('general_infos', this.$.general_infos);
        this.$.glc.registerComponent('timelines', this.$.timelines);
        this.$.glc.registerComponent('smContainer', this.$.smContainer);
        */

        var config = {
          type: 'column',
          content: [{
            type: 'row',
            height: 15,
            content: [{
              type: 'component',
              componentName: 'general_infos',
              componentState: {},
              width: 30
            }, {
              type: 'component',
              componentName: 'smContainer',
              componentState: {}
            }]
          }, {
            type: 'component',
            componentName: 'timelines',
            componentState: {},
            height: 40
          }, {
            type: 'row',
            content: [{
              type: 'stack',
              content: [{
                type: 'component',
                componentName: 'obsel_view',
                componentState: {},
                width: 30
              }, {
                type: 'component',
                componentName: 'model_view',
                componentState: {}
              }]
            }, {
              type: 'component',
              componentName: 't3se',
              componentState: {}
            }, {
              type: 'stack',
              content: [{
                type: 'component',
                componentName: 'style_view',
                componentState: {},
                width: 30
              }, {
                type: 'component',
                componentName: 'style_text',
                componentState: {}
              }]
            }]
          }]
        };

        var list = {
          'general_infos': this.$.general_infos,
          'timelines': this.$.timelines,
          'smContainer': this.$.smContainer,
          'obsel_view': this.$.obsel_view,
          'model_view': this.$.model_view,
          't3se': this.$.t3se,
          'style_view': this.$.style_view,
          'style_text': this.$.style_text,
        };

        this.$.glc.registerComponents(list, config);

        this.$.glc.addEventListener('itemDestroyed', function(evt){

        }.bind(this));
      },

      refresh: function() {
        if (!this._loading) {
          //this._loadTrace();

          console.log(this.traceUrl);

          this.$.traceLoader.addEventListener('PACKAGE_LOADED', function(evt){
            this.$.tttv.updateVisu();
          }.bind(this));

          this.$.traceLoader.addEventListener('TRACE_READY', function(evt){
            console.log("Trace ready");
            console.log(this.$.traceLoader._trace);
            this.$.traceLoader.loadObsels();

            var begin = this.$.traceLoader.getBeginObsel().begin;
            var end = this.$.traceLoader.getEndObsel().end;

            this.$.tttv.begin = this.$.tttt.begin = begin;
            this.$.tttv.end = this.$.tttt.end = end;

            this.$.tttv.initVisu();
            this.$.tttt.initVisu();


            this.$.tttt.updateVisu(begin, end);
            this.$.tttv.displayObsels(begin, end, []);
          }.bind(this));

          this.$.traceLoader.loadTrace();
        }
      },

      /////////////////////////////////
      // RESOURCES LOADING FUNCTIONS //
      /////////////////////////////////

      _onTraceUrlChanged: function() {
        if (this.traceUrl !== "") {
          this.set('_trace', new Samotraces.Ktbs.Trace(this.traceUrl));
        }
      },

      _loadTrace: function() {

        var that = this;

        this._trace.load(150000)
          .then(function() {
            that._loadModel();
          })
          .catch(function(err) {
            console.log(err);
          });

      },

      _loadModel: function() {
        var that = this;
        this.set('_model', new Samotraces.Ktbs.Model(this._trace.model_uri));

        this._model.load()
          .then(function() {

            for (var i = 0; i < that._model.list_type_obsels.length; i++)
              that.push('_listTypeObsels', that._model.list_type_obsels[i]['@id'].replace('#', 'm:'));

            for (i = 0; i < that._model.list_type_attributes.length; i++)
              that.push('_listTypeAttributes', that._model.list_type_attributes[i]['@id'].replace('#', 'm:'));

            that._loadStyleSheets();

            //TODO remove todo
            //TODO Remove comments
            that._getObselCount();
          })
          .catch(function(err) {
            console.log(err);
          });
      },

      _loadStyleSheets: function() {
        // TODO: LOAD THE STYLE SHEETS HERE.

        //TODO fake ontology used here.
        if (this._model.model_properties['http://taaabs-hubble/onto#timeline-stylesheet']) {

          this._setStylesheets(JSON.parse(this._model.model_properties['http://taaabs-hubble/onto#timeline-stylesheet']));

        } else if (this._trace.attributes['http://taaabs-hubble/onto#timeline-stylesheet']) {

          //TODO Get stylesheet from traces

        } else {

          this._createDefaultTypeStyles();
        }

      },

      _createDefaultTypeStyles: function() {

        function get_random_symbol() {
          var color = '#' + Math.floor(Math.random() * 16777215).toString(16);
          var shape = ['DIAMOND', 'CIRCLE', 'SQUARE', 'STAR'][Math.floor(Math.random() * 4)];
          return {
            color: color,
            shape: shape
          };
        }

        for (var i = 0; i < this._model.list_type_obsels.length; i++) {
          var rule = {
            typeObsel: {
              name: this._model.list_type_obsels[i]['@id'].replace('#', 'm:')
            },
            enabled: true,
            attributes: [],
            symbol: get_random_symbol()
          };
          this._addRuleToStylesheet(rule);
        }

        var _stylesheet = {
          obj: {
            name: 'default stylesheet',
            description: 'This is the default stylesheet.',
            rules: this._stylesList,
          },
          saved: false
        };

        this.push('_stylesheets', _stylesheet);
        this.set('_stylesheet', this._stylesheets[0]);

      },

      _setStylesheets: function(_stylesheets) {
        for (var i = 0; i < _stylesheets.length; i++) {
          this.push('_stylesheets', {
            obj: _stylesheets[i],
            saved: true
          });
          this.set('_stylesheet', this._stylesheets[0]);
          this.set('_stylesList', this._stylesheet.obj.rules);
        }
      },

      _getObselCount: function() {
        var that = this;
        // Retrieve obsel count
        var base = new Samotraces.Ktbs.Base(that._trace.base_uri);
        base.load_properties(['obselCount'])
          .then(function(resources) {
            if (resources) {
              for (var i in resources) {
                if (that._trace.base_uri + resources[i]['@id'] === that._trace.uri) {
                  that.set('_obselCount', resources[i].obselCount);
                }
              }
            }
            that._retrieveObsels();
          })
          .catch(function(err) {
            console.log(err);
          });
      },

      _retrieveObsels: function() {
        var that = this;
        // Retrieve the obsels
        this._getFirstObsel()
          .then(function() {
            that._getLastObsel()
              .then(function() {
                that.fire('getObsels');
              })
              .catch(function(err) {
                console.log(err);
              });
          })
          .catch(function(err) {
            console.log(err);
          });
      },

      //////////////////////////////////////
      // RETRIEVE OBSEL PROCESS FUNCTIONS //
      //////////////////////////////////////

      _getFirstObsel: function() {
        var that = this;
        return new Promise(function(resolve, reject) {
          that._trace.list_obsels({
              'limit': '1'
            })
            .then(function(list) {
              that._trace.attributes.traceBegin = list[0].begin;
              that.set('_traceBegin', list[0].begin);
              resolve();
            })
            .catch(function(err) {
              console.log(err);
              reject();
            });
        });
      },

      _getLastObsel: function() {
        var that = this;
        return new Promise(function(resolve, reject) {
          that._trace.list_obsels({
              'limit': '1',
              'reverse': 'true'
            })
            .then(function(list) {
              that._trace.attributes.traceEnd = list[0].end;
              that.set('_traceEnd', list[0].end);
              resolve();
            })
            .catch(function(err) {
              console.log(err);
              reject();
            });
        });
      },

      _getObsels: function() {
        var that = this;
        if (!this._lastObsel) {
          that._trace.list_obsels({
              'limit': '100'
            })
            .then(function(list) {
              for (var i = 0; i < list.length; i++) {
                that.push('_obsels', list[i]);
              }
              that.set('_lastObsel', list[list.length - 1]['@id']);
              that._initTimeline(list);
              that.fire('getObsels');
            })
            .catch(function(err) {
              console.log(err);
            });
        } else {
          this._getNextObsels()
            .then(function(lastObsel) {
              if (lastObsel) {
                that.set('_lastObsel', lastObsel);
                that.fire('getObsels');
              } else {
                that.$.progressInner.style.opacity = 0;
              }
            })
            .catch(function(err) {
              console.log(err);
            });
        }
      },

      _getNextObsels: function(limit) {
        limit = limit || 100;
        var that = this;
        return new Promise(function(resolve, reject) {
          that._trace.list_obsels({
              'after': that._lastObsel,
              'limit': limit
            })
            .then(function(list) {
              for (var i = 0; i < list.length; i++) {
                that.push('_obsels', list[i]);
              }
              if (that.obselCount !== 0) {
                that.$.progressInner.style.width = that._obsels.length * that.$.progress.getBoundingClientRect().width / that._obselCount;
              }
              if (list.length > 0)
                resolve(list[list.length - 1]['@id']);
              else
                resolve(null);
            })
            .catch(function(err) {
              console.log(err);
              reject();
            });
        });
      },

      //////////////////
      // UI FUNCTIONS //
      //////////////////

      _toggleView: function(e) {
        this.set(Polymer.dom(e).rootTarget.getAttribute('data-prop'), Polymer.dom(e).rootTarget.getAttribute('data-val'));
        if (Polymer.dom(e).rootTarget.getAttribute('data-prop') === '_obselOrModelView') {
          if (Polymer.dom(e).rootTarget.getAttribute('data-val') === '0') {
            this.$.obselViewBtn.classList.add('activePanel');
            this.$.modelViewBtn.classList.remove('activePanel');
          } else {
            this.$.obselViewBtn.classList.remove('activePanel');
            this.$.modelViewBtn.classList.add('activePanel');
          }
        }
      },

      _addAttributeToStyle: function(e) {
        this.$.t3se.addAttribute(e.model.item.name, e.model.item.value);
      },

      /**
       * Add the type selected to the style rule.
       *
       * @param {!required} e {String} Click event.
       *
       * @method _addModelTypeToRule
       */
      _addModelTypeToRule: function(e) {
        this.$.t3se.setType(e.model.item);
      },

      /**
       * Add the attribute selected to the style rule.
       *
       * @param {!required} e {String} Click event.
       *
       * @method _addModelAttributeToRule
       */
      _addModelAttributeToRule: function(e) {
        this.$.t3se.addAttribute(e.model.item, null, "");
      },

      /**
       * Returns the `iron-icon` value according to the enabled status of the rule.
       *
       * @param {!required} enabled {String} Enabled status of the rule.
       *
       * @method _getVisibility
       */
      _getVisibility: function(enabled) {
        return (enabled) ? 'icons:visibility' : 'icons:visibility-off';
      },

      /**
       * Triggered on the `visibility` icon is clicked.
       * Toggle the `rule` enabled attribute.
       *
       * @method _onVisibilityClicked
       */
      _onVisibilityClicked: function(e) {
        this.set('_stylesList.#' + e.model.index + '.enabled', !e.model.item.enabled);
        this._updateDisplay();
      },

      /**
       *
       *
       * @param {!required} e {String} Event from click.
       *
       * @method _onSettingsClicked
       */
      _onSettingsClicked: function(e) {
        this.$.t3se.setRule(this._stylesList[e.model.index]);
      },

      /**
       *
       *
       * @param {!required} e {String} Event from click.
       *
       * @method _onDeleteClicked
       */
      _onDeleteClicked: function(e) {
        this.splice('_stylesList', e.model.index, 1);
        this._updateDisplay();
      },

      /**
       * .
       *
       * @param {!required} e {String} . Event from click.
       *
       * @method _onDuplicateClicked
       */
      _onDuplicateClicked: function(e) {

        // Copy the curret rule.
        var new_rule = JSON.parse(JSON.stringify(this._stylesList[e.model.index]));
        this.push('_stylesList', new_rule);
        this.$.t3se.setRule(this._stylesList[this._stylesList.length - 1]);
      },

      /**
       * Toggle the stylesheet manager panel.
       *
       * @method _onStylesheetsManagerSettingsClick
       */
      _onStylesheetsManagerSettingsClick: function() {
        this.set('_hideStylesheetsManager', !this._hideStylesheetsManager);
      },

      /**
       * Return the border color of a stylesheet element in the stylesheets manager,
       * according to weither this stylesheet has been saved or not in a model.
       *
       * @param {!required} item {String} The stylesheet displayed.
       *
       * @method _getStylesheetStatusColor
       */
      _getStylesheetStatusColor: function(item) {
        return (item.saved) ? '#87D37C' : '#EF5E4A';
      },

      ///////////////////////////////
      // OBSEL INSPECTOR FUNCTIONS //
      ///////////////////////////////

      _onObselSelectedChange: function() {
        if (this._obselSelected) {
          this.set('_obselSelected.attributes', []);
          var keys = Object.keys(this._obselSelected);
          for (var i = 0; i < keys.length; i++) {
            if (keys[i] !== "@id" && keys[i] !== "@type" && keys[i] !== "begin" && keys[i] !== "end" && keys[i] !== "attributes")
              this.push('_obselSelected.attributes', {
                "name": keys[i],
                "value": this._obselSelected[keys[i]]
              });
          }
          this.set('_obselSelected.id', this._obselSelected['@id']);
          this.set('_obselSelected.type', this._obselSelected['@type']);
        }
      },

      _getDateFormatted: function(date) {
        return (new Date(date).toLocaleString());
      },

      ////////////////////////
      // TIMELINE FUNCTIONS //
      ////////////////////////

      _initTimeline: function(list) {
        this.$.tttv.initVisu();
        this.$.tttt.initVisu();
        this.$.tttv.displayObsels(this._trace.attributes.traceBegin, list[list.length - 1].end, list);
        this.$.tttt.updateVisu(this._trace.attributes.traceBegin, list[list.length - 1].end);
        var that = this;
        this.$.tttt.addEventListener('zlBeginMoved', function() {
          that.$.tttv.displayObsels(that.$.tttt._zlBegin, that.$.tttt._zlEnd, that._getObselsInRange(that.$.tttt._zlBegin, that.$.tttt._zlEnd));
          that.$.tttt.updateVisu(that.$.tttt._zlBegin, that.$.tttt._zlEnd);
        });
        this.$.tttt.addEventListener('zlEndMoved', function() {
          that.$.tttv.displayObsels(that.$.tttt._zlBegin, that.$.tttt._zlEnd, that._getObselsInRange(that.$.tttt._zlBegin, that.$.tttt._zlEnd));
          that.$.tttt.updateVisu(that.$.tttt._zlBegin, that.$.tttt._zlEnd);
        });
        this.$.tttt.addEventListener('zlGlobalMoved', function() {
          that.$.tttv.displayObsels(that.$.tttt._zlBegin, that.$.tttt._zlEnd, that._getObselsInRange(that.$.tttt._zlBegin, that.$.tttt._zlEnd));
          that.$.tttt.updateVisu(that.$.tttt._zlBegin, that.$.tttt._zlEnd);
        });
        this.$.tttv.addEventListener('zoom', function() {
          var begin = that.$.tttv._zoomBegin;
          var end = that.$.tttv._zoomEnd;
          that.$.tttv.displayObsels(begin, end, that._getObselsInRange(that.$.tttv._zoomBegin, that.$.tttv._zoomEnd));
          that.$.tttt.updateVisu(begin, end);
        });
        this.$.tttv.addEventListener('obselClicked', function(e) {
          that.set('_obselSelected', e.detail.obs);
        });
      },

      _updateDisplay: function() {
        this.$.tttv.displayObsels(this.$.tttt._zlBegin, this.$.tttt._zlEnd, this._getObselsInRange(this.$.tttt._zlBegin, this.$.tttt._zlEnd));
      },

      _getObselsInRange: function(begin, end) {
        var obsels = [];
        var i = 0;
        while (i < this._obsels.length && this._obsels[i].begin < begin) {
          i++;
        }
        while (i < this._obsels.length && this._obsels[i].end <= end) {
          obsels.push(this._obsels[i]);
          i++;
        }
        return obsels;
      },

      //////////////////////////
      // STYLESHEET FUNCTIONS //
      //////////////////////////

      /**
       * Add a new rule to `_stylesList` and `traceStyleSheet`.
       *
       * @param {!required} rule {String} The rule to add to the stylesheet.
       *
       * @method _addRuleToStylesheet
       */
      _addRuleToStylesheet: function(rule) {

        // Add the new rule to the stylesheet rules.
        this.push('_stylesList', rule);

      },

      /**
       * Save the current stylesheets into the `_model`, or the `_trace` when the first option failed.
       *
       * @method _saveStylesheetsToModel
       */
      _saveStylesheetsToModel: function() {

        var _stylesheets = [];
        for (var i = 0; i < this._stylesheets.length; i++) {
          if (this._stylesheets[i].saved)
            _stylesheets.push(this._stylesheets[i].obj);
        }

        console.log(_stylesheets);

        var _graph = this._model.graph;
        for (i = 0; i < _graph.length; i++) {
          if (_graph[i]['@type'] === 'TraceModel') {
            _graph[i]['http://taaabs-hubble/onto#timeline-stylesheet'] = JSON.stringify(_stylesheets);
          }
        }

        var that = this;
        this._model.put_model(_graph)
          .then(function() {
            console.log(' _model updated ');
            that.set('_stylesheet.saved', true);
            that._updateManagerView();
          })
          .catch(function(err) {
            console.log(err);
          });

      },

      _saveCurrentStylesheet: function() {
        this.set('_stylesheet.saved', true);
        this._saveStylesheetsToModel();
      },

      _createStylesheet: function() {
        var _stylesheet = {
          obj: {
            name: 'New stylesheet',
            description: 'New stylesheet description.',
            rules: []
          },
          saved: false
        };

        this.push('_stylesheets', _stylesheet);
        this.set('_stylesheet', this._stylesheets[this._stylesheets.length - 1]);
        this.set('_stylesList', this._stylesheet.obj.rules);
      },

      /**
       * Set the focus on the selected stylesheet.
       *
       * @param {!required} e {String} Click event.
       *
       * @method _useStylesheet
       */
      _useStylesheet: function(e) {
        this.set('_stylesheet', this._stylesheets[e.model.index]);
        this.set('_stylesList', this._stylesheet.obj.rules);
        this._updateDisplay();
      },

      /**
       * Delete the target stylesheet from the _model or _trace.
       *
       * @param {!required} e {String} Click event.
       *
       * @method _deleteCurrentStylesheet
       */
      _deleteCurrentStylesheet: function(e) {
        var _stylesheets = [];
        for (var i = 0; i < this._stylesheets.length; i++) {
          if (this._stylesheets[i].saved && i !== e.model.index)
            _stylesheets.push(this._stylesheets[i].obj);
        }

        if (this._stylesheets.length < 2) {
          this.set('_stylesheets', []);
          this._createDefaultTypeStyles();
        } else {

          if (this._stylesheets[e.model.index] === this._stylesheet) {
            this.splice('_stylesheets', e.model.index, 1);
            this.set('_stylesheet', this._stylesheets[0]);
          } else {
            this.splice('_stylesheets', e.model.index, 1);
          }
        }
        this.splice('_stylesheets', e.model.index, 1);

        console.log(_stylesheets);

        var _graph = this._model.graph;
        for (i = 0; i < _graph.length; i++) {
          if (_graph[i]['@type'] === 'TraceModel') {
            _graph[i]['http://taaabs-hubble/onto#timeline-stylesheet'] = JSON.stringify(_stylesheets);
          }
        }

        var that = this;

        this._model.put_model(_graph)
          .then(function() {
            console.log(' _model updated ');
            that.set('_stylesheet.saved', true);
            that._updateManagerView();
          })
          .catch(function(err) {
            console.log(err);
          });

      },

      _updateManagerView: function() {
        var _tmp = [];
        for (var i = 0; i < this._stylesheets.length; i++)
          _tmp.push(this._stylesheets[i]);

        this.set('_stylesheets', []);
        var that = this;
        setTimeout(function() {
          for (var i = 0; i < _tmp.length; i++)
            that.push('_stylesheets', _tmp[i]);
        }, 100);

      },

      /**
       * Fires 'APPLY_FILTER' with the stylesheet options.
       *
       * @method _onLaunchFilterClick
       */
      _onLaunchFilterClick: function() {

        var otypes = '';
        for (var i = 0; i < this._stylesheet.obj.rules.length; i++) {
          if (this._stylesheet.obj.rules[i].typeObsel !== null) {
            otypes += this._model.uri + this._stylesheet.obj.rules[i].typeObsel.name.replace('m:', '#') + ' ';
          }
        }
        otypes = otypes.slice(0, -1);

        this.$.tgm.set('presets', {
          'after': this.$.tttt._zlBegin,
          'before': this.$.tttt._zlEnd,
          'otypes': otypes
        });

        this.$.tgm.set('sourceTrace', this._trace.uri),
          this.$.filterDialog.open();
      }

    });
  </script>
</dom-module>
